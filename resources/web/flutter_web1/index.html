<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="/web/flutter_web/">
  <!-- <base href="/web/device-control/"> --> <!-- --base-href=/knowledge.io/ -->

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="web">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>web</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>

  <script>
    function test_mqtt_unsubscribe() {
      body = {
        header:{
          sequenceId: 202519,
        },
        payload:{
          cmd: "sw_StopMachineStateSubscription",
          params: {},
        }
      };

      window.wx.postMessage(JSON.stringify(body));
    }

    function test_mqtt_subscribe() {
      body = {
        header:{
          sequenceId: 202503,
        },
        payload:{
          cmd: "sw_SubscribeMachineState",
          params: {},
          event_id: "subscribe1",
        }
      };

      window.wx.postMessage(JSON.stringify(body));
    }

    function test_mqtt_subscribe_filter(){
      body  = {
        header:{
          sequenceId: 202510,
        },
        payload:{
          cmd: "sw_SetSubscribeFilter",
          params: {
            "targets":{
              "gcode_move": null,
              "toolhead": ["position", "status"]
            }
          }
        }
      };
      window.wx.postMessage(JSON.stringify(body));
    }

    function test_mqtt_send_gcodes(){
      body  = {
        header:{
          sequenceId: 202592,
        },
        payload:{
          cmd: "sw_SendGCodes",
          params: {
            "script":[
              "T0",
              "T1",
              "T2",
              "T3",
            ]
          }
        }
      };
      window.wx.postMessage(JSON.stringify(body));
    }

    function test_mqtt_machine_info(){
      body  = {
        header:{
          sequenceId: 202502,
        },
        payload:{
          cmd: "sw_GetMachineState",
          params: {
            "targets":{
              "gcode_move": null,
              "toolhead": ["position", "status"]
            }
          }
        }
      };
      window.wx.postMessage(JSON.stringify(body));
    }

    function test_mqtt_machine_objects(){
      body = {
        header:{
          sequenceId: 202504,
        },
        payload:{
          cmd: "sw_GetMachineObjects",
        }
      };
      window.wx.postMessage(JSON.stringify(body));
    }

    function test_mqtt_disconnect() {
      body = {
        header:{
          sequenceId: 202500,
        },
        payload:{
          cmd: "sw_DisConnect",
        }
      }
      window.wx.postMessage(JSON.stringify(body));
    }

    function test_mqtt_connect() {
      body = {
        header:{
          sequenceId: 202501,
        },
        payload:{
          cmd: "sw_Connect",
          params: {
            ip: "172.18.1.66",
            port: 1883,
            sn: "BE667E5F8A060BDF",
          }
        }
      }
      window.wx.postMessage(JSON.stringify(body));
    }


    function test_mqtt_subscribe_response_message_timer() {
      var timer = setInterval(function() {
        test_mqtt_subscribe_response();
      }, 2000);
      setTimeout(function() {
        clearInterval(timer);
      }, 10000);
    }

    function test_mqtt_subscribe_response() {
      var body =  {
                    "header": {
                        "event_id": "subscribe_machine_state"
                    },
                    "payload": {
                        "code": 200,
                        "data": [
                            {
                                "display_status": {
                                    "message": null,
                                    "progress": 0.45
                                },
                                "extruder": {
                                    "can_extrude": true,
                                    "power": 0.4824050874358382,
                                    "pressure_advance": 0.015,
                                    "smooth_time": 0.04,
                                    "target": 230,
                                    "temperature": 229.88
                                },
                                "extruder1": {
                                    "can_extrude": false,
                                    "power": 0,
                                    "pressure_advance": 0.015,
                                    "smooth_time": 0.04,
                                    "target": 0,
                                    "temperature": 29.82
                                },
                                "extruder2": {
                                    "can_extrude": false,
                                    "power": 0,
                                    "pressure_advance": 0.015,
                                    "smooth_time": 0.04,
                                    "target": 0,
                                    "temperature": 29.96
                                },
                                "extruder3": {
                                    "can_extrude": false,
                                    "power": 0,
                                    "pressure_advance": 0.015,
                                    "smooth_time": 0.04,
                                    "target": 0,
                                    "temperature": 30.71
                                },
                                "fan": {
                                    "rpm": null,
                                    "speed": 1
                                },
                                "fan_generic cavity_fan": {
                                    "rpm": 2293.8530734755464,
                                    "speed": 0.7
                                },
                                "gcode_move": {
                                    "absolute_coordinates": true,
                                    "absolute_extrude": false,
                                    "extrude_factor": 1,
                                    "gcode_position": [
                                        128.125,
                                        144.559,
                                        6.8,
                                        4179.2542500048585
                                    ],
                                    "homing_origin": [
                                        0,
                                        0,
                                        0,
                                        0
                                    ],
                                    "position": [
                                        128.125,
                                        144.559,
                                        6.8,
                                        169664.43720992337
                                    ],
                                    "speed": 11054.348,
                                    "speed_factor": 1
                                },
                                "heater_bed": {
                                    "can_extrude": null,
                                    "power": 0.07280463005309298,
                                    "pressure_advance": null,
                                    "smooth_time": null,
                                    "target": 55,
                                    "temperature": 54.97
                                },
                                "led cavity_led": {
                                    "color_data": [
                                        [
                                            0,
                                            0,
                                            0,
                                            1
                                        ]
                                    ]
                                },
                                "print_stats": {
                                    "filament_used": 4079.2542500048585,
                                    "filename": "1/1指尖陀螺_PLA_1h17m.gcode",
                                    "info": {
                                        "current_layer": null,
                                        "total_layer": null
                                    },
                                    "message": "",
                                    "print_duration": 2296.5128470530035,
                                    "state": "printing",
                                    "total_duration": 2305.2522525569657
                                },
                                "print_task_config": {
                                    "auto_bed_leveling": true,
                                    "extruder_map_table": [
                                        0,
                                        1,
                                        2,
                                        3
                                    ],
                                    "filament_color": [
                                        16711680,
                                        65280,
                                        255,
                                        16777215
                                    ],
                                    "filament_type": [
                                        "NONE",
                                        "NONE",
                                        "NONE",
                                        "NONE"
                                    ],
                                    "time_lapse_camera": false
                                },
                                "temperature_sensor cavity": {
                                    "measured_max_temp": 0,
                                    "measured_min_temp": -109.28,
                                    "temperature": -40.4
                                },
                                "toolhead": {
                                    "axis_maximum": [
                                        270,
                                        335,
                                        280,
                                        0
                                    ],
                                    "axis_minimum": [
                                        0,
                                        0,
                                        0,
                                        0
                                    ],
                                    "estimated_print_time": 189077.40531407812,
                                    "extruder": "extruder",
                                    "homed_axes": "xyz",
                                    "max_accel": 10000,
                                    "max_velocity": 500,
                                    "minimum_cruise_ratio": 0.5,
                                    "position": [
                                        128.125,
                                        144.559,
                                        10.52774598675305,
                                        169664.43720992337
                                    ],
                                    "print_time": 189079.63617631845,
                                    "square_corner_velocity": 5,
                                    "stalls": 1
                                },
                                "virtual_sdcard": {
                                    "file_path": "/userdata/printer_data/gcodes/1/1指尖陀螺_PLA_1h17m.gcode",
                                    "file_position": 3584284,
                                    "file_size": 8457526,
                                    "is_active": true,
                                    "progress": 0.4237981650898856
                                },
                                "webhooks": {
                                    "state": "ready",
                                    "state_message": "Printer is ready"
                                }
                            },
                            // 541096.928877337, //获取当前的时间 代码获取  new Date().getTime()
                            new Date().getTime(), //获取当前的时间 代码获取  541096.928877337, 
                        ],
                        "msg": "OK"
                    }
                };
      console.log("subscribe_machine_state response message: " + JSON.stringify(body) );
      !window.wx && window.postMessage(JSON.stringify(body), '*'); // 调用 window.postMessage 传递消息给 flutter
    }

    function getDeviceData() {
      var devices = { 
          '90F3A2F30063C233': {
            'ip': '172.18.1.33',
            'port': 1883,
            'name': 'lava-90F-233',
            'sn': '90F3A2F30063C233',
          },
          '9BD4E436F33D0B56': {
            'ip': '172.18.0.46',
            'port': 1883,
            'name': 'lava-9BD-B56',
            'sn': '9BD4E436F33D0B56'
          },
          'BE667E5F8A060BDF': {
            'ip': '172.18.1.91',
            'port': 1883,
            'name': 'lava-BE6-BDF',
            'sn': 'BE667E5F8A060BDF'
          },
          'BC0810C948A828C0': {
            'ip': '172.18.0.62',
            'port': 1883,
            'name': 'lava-BC0-8C0',
            'sn': 'BC0810C948A828C0'
          },
          '58317961E7DBEF34': {
            'ip': '172.18.1.54',
            'port': 1883,
            'name': 'lava-583-F34',
            'sn': '58317961E7DBEF34'
          },
          'A4C0111397B11BBB': {
            'ip': '172.18.0.65',
            'port': 1883,
            'name': 'lava-A4C-BBB',
            'sn': 'A4C0111397B11BBB'
          }
      };
      return devices;
    }

    function simulateResponse(jsonMessage) {
      try {
        // 反序列化 header 和 payload
        const data = JSON.parse(jsonMessage);
        var header = data.header;
        var payload = data.payload;

        // 反序列化 header 和 payload
        header['event_id'] = payload['event_id']; 
        header['cmd'] = payload['cmd']
        // 开始机器发现
        var devices = getDeviceData();
        var mokeData={
          "header": header,
          "payload": {
            'code': 200,
            'data': devices,
            'msg': 'ok',
          }
        };
        console.log("simulateResponse message: " + JSON.stringify(mokeData) );
        window.postMessage(JSON.stringify(mokeData), '*'); // 调用 window.postMessage 传递消息给 flutter
      } catch (error) {
        console.error("Error parsing JSON:", error);
      }
    }

    function ackResponse(jsonMessage) {
      try {
        // 反序列化 header 和 payload
        const data = JSON.parse(jsonMessage);
        var header = data.header;
        var payload = data.payload;
        // 反序列化 header 和 payload
        header['event_id'] = payload['event_id']; 

        if(header['event_id'] == null) {
          alert(jsonMessage);
        }

        // 开始机器发现
        var devices = getDeviceData();
        var mokeData={
          "header": header,
          "payload": {
            'code': 200,
            'data': null,
            'msg': 'ok',
          }
        };
        console.log("ackResponse message: " + JSON.stringify(mokeData) );
        window.postMessage(JSON.stringify(mokeData), '*'); // 调用 window.postMessage 传递消息给 flutter
      } catch (error) {
        console.error("Error parsing JSON:", error);
      }
    }

    window.sendMessage = function (message) {
      console.log("I am proxy in html to send message to container: " + message);
      //收到请求后，模拟收到响应结果
      !window.wx && ackResponse(message);
      // 调用 window.postMessage 传递消息给 flutter
      window.wx &&  window.wx.postMessage(message); // 调用 window.postMessage 传递消息给 原生系统
      ///模拟收到响应结果5000
      if(!window.wx) {
        console.log('i cant find window.wx, so i simulate a return by postMessage')
        setTimeout(simulateResponse(message), 5000)
      }
    }

  </script>
  <!-- <img src="http://127.0.0.1:13619/profiles/Snapmaker/Snapmaker Artisan_cover.png" alt="Snapmaker Orca" style="width: 100px; height: 100px;"> -->
</body>
</html>
